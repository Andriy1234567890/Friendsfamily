<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçØ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>üç∫</span><span>ƒåapovan√©</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
  </div>

<script>
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  // –í—Å—ñ –≤–∫–ª–∞–¥–∫–∏
  const categories = ['nonalcohol', 'alcohol', 'stock', 'purchase', 'monin', 'capovane'];

  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.remove('hidden');

      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.querySelector('h1').textContent = btn.textContent.trim();
      }

      renderTable(btn.dataset.tab);
    });
  });

  let currentSort = { key: 'name', asc: true };

  // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏ –¥–ª—è –º–æ–Ω—ñ–Ω, —á–∞–ø–æ–≤–∞–Ω–µ, –∞–ª–∫–æ, –Ω–µ–∞–ª–∫–æ (–∑ –∫–Ω–æ–ø–∫–æ—é "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –Ω–∞–∫—É–ø")
  const demoProducts = {
    alcohol: [
      {name: "–ü—Ä–æ–¥—É–∫—Ç A", quantity: 10},
      {name: "–ü—Ä–æ–¥—É–∫—Ç B", quantity: 5},
      {name: "–ü—Ä–æ–¥—É–∫—Ç C", quantity: 8}
    ],
    nonalcohol: [
      {name: "–ü—Ä–æ–¥—É–∫—Ç D", quantity: 12},
      {name: "–ü—Ä–æ–¥—É–∫—Ç E", quantity: 7},
    ],
    monin: [
      {name: "Monin A", quantity: 15},
      {name: "Monin B", quantity: 9},
    ],
    capovane: [
      {name: "ƒåapovan√© A", quantity: "20L"},
      {name: "ƒåapovan√© B", quantity: "15L"},
    ]
  };

  async function renderTable(tabName) {
    const container = document.getElementById(tabName);
    
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ –¥–æ–¥–∞—î–º–æ —ó—Ö –∑ –∫–Ω–æ–ø–∫–∞–º–∏
    if (['alcohol', 'nonalcohol', 'monin', 'capovane'].includes(tabName)) {
      // –í–∏–≤–æ–¥–∏–º–æ —Å–ø–æ—á–∞—Ç–∫—É —Ñ–æ—Ä–º—É + —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —è–∫ —Ä–∞–Ω—ñ—à–µ, –∞ –ø–æ—Ç—ñ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏
      const { data, error } = await client.from(tabName).select('*');
      if(error){
        console.error(error);
        container.innerHTML = `<p class="text-red-600">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.</p>`;
        return;
      }

      container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°ok (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      <div class="flex gap-4 mb-2">
        <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa n√°zvu</button>
        <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa mno≈æstva</button>
      </div>
      <table class="w-full table-auto border border-gray-300 mb-4">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">Meno</th>
            <th class="p-2 border">Zvy≈°ok</th>
            <th class="p-2 border">Akcia</th>
          </tr>
        </thead>
        <tbody id="${tabName}-table"></tbody>
      </table>
      <h2 class="text-xl font-semibold mb-2">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏</h2>
      <table class="w-full table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">–ù–∞–∑–≤–∞</th>
            <th class="p-2 border">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th class="p-2 border">–î—ñ—è</th>
          </tr>
        </thead>
        <tbody id="${tabName}-demo-table"></tbody>
      </table>
      `;

      // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö (—Ñ–æ—Ä–º—É)
      document.getElementById(`form-${tabName}`).addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById(`${tabName}-name`).value.trim();
        const quantityInput = document.getElementById(`${tabName}-quantity`).value.trim();
        let quantity = quantityInput;

        if(tabName !== 'capovane'){
          quantity = parseFloat(quantityInput);
          if (isNaN(quantity) || quantity < 0) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ.");
            return;
          }
        }

        if (name && quantityInput) {
          await client.from(tabName).insert([{ name, quantity }]);
          renderTable(tabName);
        }
      });

      // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ –∑ –±–∞–∑–∏
      const tbody = document.getElementById(`${tabName}-table`);
      tbody.innerHTML = '';

      if (data) {
        data.sort((a, b) => {
          const valA = a[currentSort.key];
          const valB = b[currentSort.key];
          if(currentSort.key === 'quantity'){
            return currentSort.asc
              ? parseFloat(valA) - parseFloat(valB)
              : parseFloat(valB) - parseFloat(valA);
          }
          return currentSort.asc
            ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true })
            : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
        });

        for (const item of data) {
          const quantityClass = (tabName === 'stock' && item.quantity <= 2) ||
                                ((tabName === 'alcohol' || tabName === 'nonalcohol') && item.quantity <= 5)
                                ? 'text-red-600 font-bold' : '';

          const row = document.createElement('tr');
          row.className = "border-b";
          row.innerHTML = `
            <td class="p-2 border">${item.name}</td>
            <td class="p-2 border ${quantityClass}">${item.quantity}</td>
            <td class="p-2 border">
              <button onclick="deleteItem('${tabName}', ${item.id})" class="text-red-500">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </td>
          `;
          tbody.appendChild(row);
        }
      }

      // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏ –∑ –∫–Ω–æ–ø–∫–∞–º–∏
      const demoTbody = document.getElementById(`${tabName}-demo-table`);
      demoTbody.innerHTML = '';
      for (const prod of demoProducts[tabName]) {
        const tr = document.createElement('tr');
        tr.className = "border-b";
        tr.innerHTML = `
          <td class="p-2 border">${prod.name}</td>
          <td class="p-2 border">${prod.quantity}</td>
          <td class="p-2 border">
            <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="addToPurchase('${prod.name}', '${prod.quantity}')">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –Ω–∞–∫—É–ø</button>
          </td>
        `;
        demoTbody.appendChild(tr);
      }

      return;
    }

    // –î–ª—è –≤–∫–ª–∞–¥–æ–∫ stock —Ç–∞ purchase ‚Äì –ª–æ–≥—ñ–∫–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—è (–∑ —Ñ–æ—Ä–º–æ—é, —Ç–∞–±–ª–∏—Ü–µ—é, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è–º)

    const { data, error } = await client.from(tabName).select('*');
    if(error){
      console.error(error);
      return;
    }

    const containerStockPurchase = document.getElementById(tabName);
    containerStockPurchase.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°ok (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        ${tabName === 'purchase' ? 
          `<textarea id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mb-2"></textarea>` 
          : ''
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      <div class="flex gap-4 mb-2">
        <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa n√°zvu</button>
        <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa mno≈æstva</button>
      </div>
      <table class="w-full table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">Meno</th>
            <th class="p-2 border">Zvy≈°ok</th>
            ${tabName === 'purchase' ? `<th class="p-2 border">Koment√°r</th>` : ''}
            <th class="p-2 border">Akcia</th>
          </tr>
        </thead>
        <tbody id="${tabName}-table"></tbody>
      </table>
    `;

    document.getElementById(`form-${tabName}`).addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById(`${tabName}-name`).value.trim();
      const quantityInput = document.getElementById(`${tabName}-quantity`).value.trim();
      const comment = tabName === 'purchase' ? document.getElementById(`${tabName}-comment`).value.trim() : null;
      let quantity = quantityInput;

      if(tabName !== 'capovane'){
        quantity = parseFloat(quantityInput);
        if (isNaN(quantity) || quantity < 0) {
          alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ.");
          return;
        }
      }

      if (name && quantityInput) {
        const insertData = { name, quantity };
        if (comment !== null) insertData.comment = comment;
        await client.from(tabName).insert([insertData]);
        renderTable(tabName);
      }
    });

    const tbodySP = document.getElementById(`${tabName}-table`);
    tbodySP.innerHTML = '';

    if (data) {
      data.sort((a, b) => {
        const valA = a[currentSort.key];
        const valB = b[currentSort.key];
        if(currentSort.key === 'quantity'){
          return currentSort.asc
            ? parseFloat(valA) - parseFloat(valB)
            : parseFloat(valB) - parseFloat(valA);
        }
        return currentSort.asc
          ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true })
          : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
      });

      for (const item of data) {
        const quantityClass = (tabName === 'stock' && item.quantity <= 2) ||
                              ((tabName === 'alcohol' || tabName === 'nonalcohol') && item.quantity <= 5)
                              ? 'text-red-600 font-bold' : '';

        const row = document.createElement('tr');
        row.className = "border-b";
        row.innerHTML = `
          <td class="p-2 border">${item.name}</td>
          <td class="p-2 border ${quantityClass}">${item.quantity}</td>
          ${tabName === 'purchase' ? `<td class="p-2 border">${item.comment || ''}</td>` : ''}
          <td class="p-2 border">
            <button onclick="deleteItem('${tabName}', ${item.id})" class="text-red-500">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>
        `;
        tbodySP.appendChild(row);
      }
    }
  }

  function sortBy(tab, key) {
    if (currentSort.key === key) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable(tab);
  }

  async function deleteItem(table, id) {
    if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?")){
      await client.from(table).delete().eq('id', id);
      renderTable(table);
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É –≤ —Ç–∞–±–ª–∏—Ü—é purchase
  async function addToPurchase(name, quantity) {
    await client.from('purchase').insert([{ name, quantity, comment: "–î–æ–¥–∞–Ω–æ –∑ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó" }]);
    if(document.getElementById('purchase').classList.contains('hidden') === false) {
      renderTable('purchase');
    }
  }

  // –ê–≤—Ç–æ–≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–µ—Ä—à–æ—ó –≤–∫–ª–∞–¥–∫–∏
  renderTable('alcohol');
  document.querySelectorAll('.sidebar-tab')[0].classList.add('bg-gray-300');

</script>
</body>
</html>
