<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçØ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>üç∫</span><span>ƒåapovan√©</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
  </div>

<script>
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Supabase
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  const categories = ['nonalcohol', 'alcohol', 'stock', 'monin', 'capovane', 'purchase'];

  // –ü–µ—Ä–µ–º—ñ–Ω–Ω–∞ –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  let currentSort = { key: 'name', asc: true };

  // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è —Å–∞–π–¥–±–∞—Ä—É –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ç–∞–±—ñ–≤ —É —Å–∞–π–¥–±–∞—Ä—ñ
  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—É –≤–∫–ª–∞–¥–∫—É
      showTab(btn.dataset.tab);

      // –ó–∞–∫—Ä–∏—Ç–∏ —Å–∞–π–¥–±–∞—Ä –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
      }
    });
  });

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –≤–∏–±—Ä–∞–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
  function showTab(tabName) {
    // –•–æ–≤–∞—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    // –ü–æ–∫–∞–∑—É—î–º–æ –≤–∏–±—Ä–∞–Ω—É
    const tab = document.getElementById(tabName);
    tab.classList.remove('hidden');

    // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const sidebarBtn = document.querySelector(`.sidebar-tab[data-tab="${tabName}"]`);
    if (sidebarBtn) {
      document.querySelector('h1').textContent = sidebarBtn.textContent.trim();
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º–æ —Ç–∞–±–ª–∏—Ü—é
    renderTable(tabName);
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–µ—Ä—à—É –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  window.addEventListener('DOMContentLoaded', () => {
    showTab(categories[0]);
  });

  // –§—É–Ω–∫—Ü—ñ—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  function sortBy(tabName, key) {
    if(currentSort.key === key){
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable(tabName);
  }

  // –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä—É —Ç–∞–±–ª–∏—Ü—ñ
  async function renderTable(tabName) {
    const { data, error } = await client.from(tabName).select('*');
    if(error){
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);
    container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°ok (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        ${tabName === 'purchase' ? 
          `<textarea id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mb-2"></textarea>` 
          : ''
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      <div class="flex gap-4 mb-2">
        <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa n√°zvu</button>
        <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa mno≈æstva</button>
      </div>
      <table class="w-full table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'name')">Meno</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'quantity')">Zvy≈°ok</th>
            <th class="p-2 border">Zmenit</th>
            ${tabName === 'purchase' ? '<th class="p-2 border">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>' : ''}
            ${tabName === 'purchase' ? '<th class="p-2 border">–î—ñ—è</th>' : ''}
            ${tabName !== 'purchase' ? '<th class="p-2 border">–î–æ–¥–∞—Ç–∏ –≤ Nakup</th>' : ''}
          </tr>
        </thead>
        <tbody id="${tabName}-table"></tbody>
      </table>
    `;

    // –û–±—Ä–æ–±–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É
    document.getElementById(`form-${tabName}`).addEventListener('submit', async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById(`${tabName}-name`);
      const quantityInput = document.getElementById(`${tabName}-quantity`);
      const commentInput = tabName === 'purchase' ? document.getElementById(`${tabName}-comment`) : null;

      if (!nameInput.value || !quantityInput.value) return;

      const newRow = {
        name: nameInput.value.trim(),
        quantity: tabName === 'capovane' ? quantityInput.value.trim() : parseFloat(quantityInput.value),
      };
      if (tabName === 'purchase' && commentInput) {
        newRow.comment = commentInput.value.trim();
      }

      const { error } = await client.from(tabName).insert([newRow]);
      if (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ: ' + error.message);
      } else {
        nameInput.value = '';
        quantityInput.value = '';
        if (commentInput) commentInput.value = '';
        renderTable(tabName);
      }
    });

    // –°–æ—Ä—Ç—É—î–º–æ –¥–∞–Ω—ñ
    data.sort((a, b) => {
      let valA = a[currentSort.key];
      let valB = b[currentSort.key];

      if(currentSort.key === 'name'){
        valA = valA ? valA.toLowerCase() : '';
        valB = valB ? valB.toLowerCase() : '';
        if(valA < valB) return currentSort.asc ? -1 : 1;
        if(valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
      } else {
        // —á–∏—Å–ª–æ–≤–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
        return currentSort.asc ? (valA - valB) : (valB - valA);
      }
    });

    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ tbody
    const tbody = document.getElementById(`${tabName}-table`);
    tbody.innerHTML = '';

    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-100';

      tr.innerHTML = `
        <td class="border px-2 py-1">${row.name || ''}</td>
        <td class="border px-2 py-1">${row.quantity || ''}</td>
        <td class="border px-2 py-1">
          <button class="edit-btn bg-yellow-400 px-2 rounded" data-id="${row.id}" data-tab="${tabName}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
        </td>
        ${tabName === 'purchase' ? `<td class="border px-2 py-1">${row.comment || ''}</td>` : ''}
        ${tabName === 'purchase' 
          ? `<td class="border px-2 py-1"><button class="delete-btn bg-red-500 text-white px-2 rounded" data-id="${row.id}" data-tab="${tabName}">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>` 
          : `<td class="border px-2 py-1"><button class="to-purchase-btn bg-green-500 text-white px-2 rounded" data-id="${row.id}" data-tab="${tabName}">–í Nakup</button></td>`
        }
      `;
      tbody.appendChild(tr);
    });

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    tbody.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const tab = btn.dataset.tab;

        const { data: item } = await client.from(tab).select('*').eq('id', id).single();
        if(!item) return alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

        // –ü—Ä–æ—Å—Ç—ñ prompt –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        const newName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ —ñ–º‚Äô—è', item.name);
        if (newName === null) return;
        const newQuantity = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫', item.quantity);
        if (newQuantity === null) return;
        let newComment = null;
        if(tab === 'purchase') {
          newComment = prompt('–í–≤–µ–¥—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä', item.comment || '');
          if (newComment === null) return;
        }

        const updateData = {
          name: newName.trim(),
          quantity: tab === 'capovane' ? newQuantity.trim() : parseFloat(newQuantity),
        };
        if(tab === 'purchase') updateData.comment = newComment.trim();

        const { error } = await client.from(tab).update(updateData).eq('id', id);
        if(error){
          alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ' + error.message);
        } else {
          renderTable(tab);
        }
      });
    });

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è (–ª–∏—à–µ –¥–ª—è purchase)
    tbody.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const tab = btn.dataset.tab;
        if(confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')){
          const { error } = await client.from(tab).delete().eq('id', id);
          if(error){
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + error.message);
          } else {
            renderTable(tab);
          }
        }
      });
    });

    // –ö–Ω–æ–ø–∫–∏ "–í Nakup" –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ purchase
    tbody.querySelectorAll('.to-purchase-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const tab = btn.dataset.tab;

        const { data: item } = await client.from(tab).select('*').eq('id', id).single();
        if(!item) return alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

        // –î–æ–¥–∞—î–º–æ –≤ purchase
        const { error } = await client.from('purchase').insert([{
          name: item.name,
          quantity: item.quantity,
          comment: ''
        }]);
        if(error) {
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –≤ Nakup: ' + error.message);
          return;
        }

        // –í–∏–¥–∞–ª—è—î–º–æ –∑—ñ —Å—Ç–∞—Ä–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
        const { error: delErr } = await client.from(tab).delete().eq('id', id);
        if(delErr) {
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑—ñ —Å—Ç–∞—Ä–æ—ó —Ç–∞–±–ª–∏—Ü—ñ: ' + delErr.message);
          return;
        }

        renderTable(tab);
        if(tab !== 'purchase') renderTable('purchase');
      });
    });
  }
</script>
</body>
</html>
