<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Контроль запасів</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    table { width: 100%; margin-bottom: 40px; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    h2 { margin-top: 50px; }
    button { padding: 4px 10px; margin: 0 2px; }
    .decrease, .increase { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Система обліку товарів</h1>

  <div id="tables">
    <h2>Алкоголь</h2>
    <table id="alcohol"><thead><tr><th>Назва</th><th>Кількість</th><th>Дія</th></tr></thead><tbody></tbody></table>

    <h2>Безалкогольне</h2>
    <table id="nonalcohol"><thead><tr><th>Назва</th><th>Кількість</th><th>Дія</th></tr></thead><tbody></tbody></table>

    <h2>Каповане</h2>
    <table id="capovane"><thead><tr><th>Назва</th><th>Кількість</th><th>Дія</th></tr></thead><tbody></tbody></table>

    <h2>Nakup</h2>
    <table id="purchase"><thead><tr><th>Назва</th><th>Кількість</th><th>Дія</th></tr></thead><tbody></tbody></table>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = 'https://YOUR_PROJECT.supabase.co' // ← заміни
    const supabaseKey = 'YOUR_API_KEY'                     // ← заміни
    const client = createClient(supabaseUrl, supabaseKey)

    const tables = ['alcohol', 'nonalcohol', 'capovane', 'purchase'];

    const renderTable = async (tab) => {
      const { data, error } = await client.from(tab).select('*').order('id', { ascending: true });
      const tbody = document.querySelector(`#${tab} tbody`);
      tbody.innerHTML = '';

      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>
            <button class="decrease" data-id="${item.id}" data-tab="${tab}">−</button>
            ${item.quantity}
            <button class="increase" data-id="${item.id}" data-tab="${tab}">+</button>
          </td>
          ${
            tab !== 'purchase' 
            ? `<td><button class="to-purchase-btn" data-id="${item.id}" data-tab="${tab}">В Nakup</button></td>` 
            : `<td><button class="purchase-done-btn" data-id="${item.id}" data-tab="${tab}">Закуплено</button></td>`
          }
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('.increase').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tab = btn.dataset.tab;
          await client.from(tab).update({ quantity: client.sql`quantity + 1` }).eq('id', id);
          renderTable(tab);
        });
      });

      tbody.querySelectorAll('.decrease').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tab = btn.dataset.tab;
          const { data } = await client.from(tab).select('quantity').eq('id', id).single();
          if (data.quantity > 1) {
            await client.from(tab).update({ quantity: data.quantity - 1 }).eq('id', id);
          } else {
            await client.from(tab).delete().eq('id', id);
          }
          renderTable(tab);
        });
      });

      tbody.querySelectorAll('.to-purchase-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tab = btn.dataset.tab;
          const { data: item } = await client.from(tab).select('*').eq('id', id).single();
          const { error } = await client.from('purchase').insert([{
            name: item.name,
            quantity: item.quantity,
            comment: '',
            source_tab: tab
          }]);
          if (!error) {
            await client.from(tab).delete().eq('id', id);
            renderTable(tab);
            renderTable('purchase');
          }
        });
      });

      tbody.querySelectorAll('.purchase-done-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tab = btn.dataset.tab;

          if (!confirm('Ви впевнені, що товар закуплено і його потрібно перемістити в категорію?')) return;

          const { data: item, error: fetchError } = await client.from(tab).select('*').eq('id', id).single();
          if(fetchError || !item) {
            alert('Помилка отримання товару: ' + fetchError?.message);
            return;
          }

          const sourceTab = item.source_tab;
          if(!sourceTab) {
            alert('Немає інформації про початкову категорію');
            return;
          }

          const { data: existingItem } = await client.from(sourceTab).select('*').eq('name', item.name).single();

          if (existingItem) {
            const newQuantity = (existingItem.quantity || 0) + (item.quantity || 0);
            const { error: updateError } = await client.from(sourceTab).update({ quantity: newQuantity }).eq('id', existingItem.id);
            if(updateError){
              alert('Помилка оновлення кількості: ' + updateError.message);
              return;
            }
          } else {
            const { error: insertError } = await client.from(sourceTab).insert([{
              name: item.name,
              quantity: item.quantity
            }]);
            if(insertError){
              alert('Помилка додавання нового товару: ' + insertError.message);
              return;
            }
          }

          const { error: deleteError } = await client.from(tab).delete().eq('id', id);
          if(deleteError){
            alert('Помилка видалення з Nakup: ' + deleteError.message);
            return;
          }

          renderTable(tab);
          renderTable(sourceTab);
        });
      });
    };

    tables.forEach(renderTable);
  </script>
</body>
</html>
