<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçØ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>üç∫</span><span>ƒåapovan√©</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–∫—É–ø–∫—É -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow-lg max-w-sm text-center">
      <p id="modal-message" class="mb-4 text-lg font-semibold"></p>
      <button id="modal-close" class="bg-blue-500 text-white px-4 py-2 rounded">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>

<script>
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  const categories = ['nonalcohol', 'alcohol', 'stock', 'monin', 'capovane', 'purchase'];

  let currentTab = 'alcohol';
  let currentSort = { key: 'name', asc: true };

  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.remove('hidden');

      currentTab = btn.dataset.tab;

      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.querySelector('h1').textContent = btn.textContent.trim();
      } else {
        document.querySelector('h1').textContent = 'Kontrola zvy≈°kov';
      }

      renderTable(currentTab);
      toggleMarkPurchasedBtn();
    });
  });

  async function renderTable(tabName) {
    const { data, error } = await client.from(tabName).select('*');
    if(error){
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);
    container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°–æ–∫ (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        ${tabName === 'purchase' ? 
          `<textarea id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mb-2"></textarea>` 
          : ''
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      <div class="flex gap-4 mb-2">
        <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa n√°zvu</button>
        <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa mno≈æstva</button>
      </div>
      <table class="w-full table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'name')">Meno</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'quantity')">Zvy≈°–æ–∫</th>
            <th class="p-2 border">–ó–º–µ–Ω–∏—Ç–∏</th>
            ${tabName === 'purchase' ? '<th class="p-2 border">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>' : ''}
            ${tabName === 'purchase' ? '<th class="p-2 border">–í–∏–¥–∞–ª–∏—Ç–∏</th>' : ''}
            ${tabName === 'purchase' ? '<th class="p-2 border">–ó–∞–∫—É–ø–∫–∞</th>' : ''}
            ${tabName !== 'purchase' ? '<th class="p-2 border">–í Nakup</th>' : ''}
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `;

    const form = document.getElementById(`form-${tabName}`);
    form.onsubmit = async e => {
      e.preventDefault();
      const name = document.getElementById(`${tabName}-name`).value.trim();
      const quantityRaw = document.getElementById(`${tabName}-quantity`).value.trim();
      let quantity = tabName === 'capovane' ? quantityRaw : parseFloat(quantityRaw);
      if (!name || (tabName !== 'capovane' && (isNaN(quantity) || quantity < 0))) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥–∞–Ω—ñ!');
        return;
      }
      if(tabName === 'purchase'){
        const comment = document.getElementById(`${tabName}-comment`).value.trim();
        await client.from(tabName).insert([{ name, quantity, comment, category: tabName }]);
      } else {
        await client.from(tabName).insert([{ name, quantity }]);
      }
      form.reset();
      renderTable(tabName);
    };

    const tbody = container.querySelector('tbody');

    // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
    let sortedData = [...data];
    if(currentSort.key){
      sortedData.sort((a,b) => {
        if(a[currentSort.key] < b[currentSort.key]) return currentSort.asc ? -1 : 1;
        if(a[currentSort.key] > b[currentSort.key]) return currentSort.asc ? 1 : -1;
        return 0;
      });
    }

    for(const item of sortedData){
      const row = document.createElement('tr');
      row.className = "border-b";

      row.innerHTML = `
        <td class="border p-2">${item.name}</td>
        <td class="border p-2">
          ${tabName === 'capovane' ? item.quantity : parseFloat(item.quantity).toFixed(2)}
        </td>
        <td class="border p-2">
          <input type="${tabName === 'capovane' ? 'text' : 'number'}" step="${tabName === 'capovane' ? 'any' : '0.1'}" min="0" 
            value="${item.quantity}" data-id="${item.id}" data-table="${tabName}" class="quantity-input border p-1 rounded w-full" />
          <button data-id="${item.id}" data-table="${tabName}" class="update-btn bg-green-500 text-white px-2 py-1 rounded mt-1">–û–Ω–æ–≤–∏—Ç–∏</button>
        </td>
        ${tabName === 'purchase' ? `
          <td class="border p-2">
            <textarea data-id="${item.id}" data-table="${tabName}" class="w-full border p-1 rounded comment-input">${item.comment || ''}</textarea>
          </td>
          <td class="border p-2">
            <button data-id="${item.id}" data-table="${tabName}" class="delete-btn bg-red-500 text-white px-2 py-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>
          <td class="border p-2">
            <button data-id="${item.id}" data-table="${tabName}" data-category="${item.category || 'stock'}" class="purchase-btn bg-blue-600 text-white px-2 py-1 rounded">–ó–∞–∫—É–ø–∫–∞</button>
          </td>
        ` : `
          <td class="border p-2">
            <button data-id="${item.id}" data-table="${tabName}" class="add-to-purchase-btn bg-yellow-500 text-white px-2 py-1 rounded">–í Nakup</button>
          </td>
        `}
      `;

      tbody.appendChild(row);
    }

    // –ö–Ω–æ–ø–∫–∏ –û–Ω–æ–≤–∏—Ç–∏
    tbody.querySelectorAll('.update-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const table = btn.dataset.table;

        const qtyInput = tbody.querySelector(`.quantity-input[data-id="${id}"]`);
        const quantityVal = qtyInput.value.trim();

        if(table === 'purchase') {
          const commentInput = tbody.querySelector(`.comment-input[data-id="${id}"]`);
          const commentVal = commentInput.value.trim();
          await client.from(table).update({ quantity: quantityVal, comment: commentVal }).eq('id', id);
        } else {
          const q = parseFloat(quantityVal);
          if (isNaN(q) || q < 0) {
            alert("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å!");
            return;
          }
          await client.from(table).update({ quantity: q }).eq('id', id);
        }
        renderTable(table);
      });
    });

    // –ö–Ω–æ–ø–∫–∏ –í–∏–¥–∞–ª–∏—Ç–∏
    tbody.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const table = btn.dataset.table;
        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) {
          await client.from(table).delete().eq('id', id);
          renderTable(table);
        }
      });
    });

    // –ö–Ω–æ–ø–∫–∏ –í Nakup
    tbody.querySelectorAll('.add-to-purchase-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const table = btn.dataset.table;
        const item = data.find(i => i.id == id);
        if(!item) return;

        await client.from('purchase').insert([{ name: item.name, quantity: item.quantity, comment: '', category: table }]);
        await client.from(table).delete().eq('id', id);

        alert(`–¢–æ–≤–∞—Ä "${item.name}" –¥–æ–¥–∞–Ω–æ —É Nakup`);
        renderTable(table);
      });
    });

    // –ö–Ω–æ–ø–∫–∏ –ó–∞–∫—É–ø–∫–∞ (–ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ç–æ–≤–∞—Ä –Ω–∞–∑–∞–¥)
    tbody.querySelectorAll('.purchase-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const table = btn.dataset.table;
        const category = btn.dataset.category || 'stock';

        const item = data.find(i => i.id == id);
        if(!item) return;

        // –î–æ–¥–∞—î–º–æ –Ω–∞–∑–∞–¥ —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
        const { data: existingItems, error: existingError } = await client.from(category).select('*').eq('name', item.name);
        if(existingError){
          alert('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ' + existingError.message);
          return;
        }
        if(existingItems && existingItems.length > 0){
          const existing = existingItems[0];
          const newQuantity = parseFloat(existing.quantity) + parseFloat(item.quantity);
          await client.from(category).update({ quantity: newQuantity }).eq('id', existing.id);
        } else {
          await client.from(category).insert([{ name: item.name, quantity: item.quantity }]);
        }

        // –í–∏–¥–∞–ª—è—î–º–æ –∑ purchase
        await client.from('purchase').delete().eq('id', id);

        // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é purchase
        renderTable('purchase');

        // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ–≥–æ
        updatePurchasedCount(parseFloat(item.quantity));

        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        showModal(`–ó–∞–∫—É–ø–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä—É: ${item.name}, –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${item.quantity}`);
      });
    });

  }

  function sortBy(tabName, key) {
    if(currentSort.key === key) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable(tabName);
  }

  // –õ—ñ—á–∏–ª—å–Ω–∏–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
  let totalPurchased = 0;

  function updatePurchasedCount(qty) {
    totalPurchased += qty;
  }

  // –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
  const modal = document.getElementById('modal');
  const modalMessage = document.getElementById('modal-message');
  const modalCloseBtn = document.getElementById('modal-close');

  function showModal(message) {
    modalMessage.textContent = message + `\n–ó–∞–≥–∞–ª—å–Ω–∞ –∑–∞–∫—É–ø–ª–µ–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${totalPurchased.toFixed(2)}`;
    modal.classList.remove('hidden');
  }

  modalCloseBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—É–ø–ª–µ–Ω–æ" (–¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —É—Å—ñ—Ö —Ç–æ–≤–∞—Ä—ñ–≤ —ñ–∑ purchase —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó)
  const markPurchasedBtn = document.createElement('button');
  markPurchasedBtn.id = 'mark-purchased-btn';
  markPurchasedBtn.textContent = '–ó–∞–∫—É–ø–ª–µ–Ω–æ';
  markPurchasedBtn.className = 'bg-green-600 text-white px-4 py-2 rounded mt-4 hidden';
  document.querySelector('.flex-1').appendChild(markPurchasedBtn);

  markPurchasedBtn.addEventListener('click', async () => {
    const { data: purchaseItems, error: purchaseError } = await client.from('purchase').select('*');
    if (purchaseError) {
      alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ Nakup: ' + purchaseError.message);
      return;
    }
    if (!purchaseItems || purchaseItems.length === 0) {
      alert('–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –∑–∞–∫—É–ø–∫–∏');
      return;
    }

    for (const item of purchaseItems) {
      const category = item.category || 'stock';

      const { data: existingItems, error: existingError } = await client.from(category).select('*').eq('name', item.name);
      if (existingError) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É —Ç–æ–≤–∞—Ä—É –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó ' + category + ': ' + existingError.message);
        continue;
      }

      if (existingItems && existingItems.length > 0) {
        const existing = existingItems[0];
        const newQuantity = parseFloat(existing.quantity) + parseFloat(item.quantity);
        await client.from(category).update({ quantity: newQuantity }).eq('id', existing.id);
      } else {
        await client.from(category).insert([{ name: item.name, quantity: item.quantity }]);
      }

      // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
      updatePurchasedCount(parseFloat(item.quantity));

      await client.from('purchase').delete().eq('id', item.id);
    }

    alert(`–£—Å—ñ —Ç–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–æ –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π! –ó–∞–≥–∞–ª—å–Ω–∞ –∑–∞–∫—É–ø–ª–µ–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${totalPurchased.toFixed(2)}`);
    renderTable('purchase');
  });

  // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É "–ó–∞–∫—É–ø–ª–µ–Ω–æ" –ª–∏—à–µ –¥–ª—è purchase
  function toggleMarkPurchasedBtn() {
    if (currentTab === 'purchase') {
      markPurchasedBtn.classList.remove('hidden');
    } else {
      markPurchasedBtn.classList.add('hidden');
    }
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const firstTab = document.getElementById(currentTab);
    firstTab.classList.remove('hidden');
    renderTable(currentTab);
    toggleMarkPurchasedBtn();
  });

</script>
</body>
</html>
