<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçπ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>ü•§</span><span>ƒåapovan√©</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
  </div>

<script>
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  const categories = ['nonalcohol', 'alcohol', 'stock', 'purchase', 'monin', 'capovane'];

  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.remove('hidden');

      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.querySelector('h1').textContent = btn.textContent.trim();
      }

      renderTable(btn.dataset.tab);
    });
  });

  let currentSort = { key: 'name', asc: true };

  async function getTypeByName(name) {
    for(const tab of ['alcohol', 'nonalcohol', 'stock', 'monin', 'capovane']){
      const { data } = await client.from(tab).select('name').eq('name', name).maybeSingle();
      if(data) {
        if(tab === 'alcohol') return 'alcohol';
        if(tab === 'nonalcohol') return 'nonalcohol';
        if(tab === 'monin') return 'nonalcohol';
        if(tab === 'capovane') return 'nonalcohol';
        if(tab === 'stock') return 'stock';
      }
    }
    return 'unknown';
  }

  async function maybeAddToPurchase(name, quantity) {
    // –Ø–∫—â–æ —î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤, —è–∫—ñ –Ω–µ —Ç—Ä–µ–±–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    const excludeAutoSend = ['SpecialProduct1', 'SpecialProduct2']; // –ó–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤–æ—ó —Ç–æ–≤–∞—Ä–∏

    // –Ø–∫—â–æ —Ç–æ–≤–∞—Ä –≤ excludeAutoSend —ñ –∫—ñ–ª—å–∫—ñ—Å—Ç—å <1, –Ω–µ –¥–æ–¥–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    if(excludeAutoSend.includes(name) && parseFloat(quantity) < 1) return;

    const { data: exists } = await client.from('purchase').select('*').eq('name', name).maybeSingle();
    if (!exists) {
      const type = await getTypeByName(name);
      await client.from('purchase').insert([{ name, quantity, type }]);
    }
  }

  async function renderTable(tabName) {
    let { data, error } = await client.from(tabName).select('*');
    if(error){
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);

    // –î–ª—è –≤–∫–ª–∞–¥–∫–∏ purchase –¥–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä —Ç–∏–ø—É
    let filterHtml = '';
    if(tabName === 'purchase'){
      filterHtml = `
        <div class="flex gap-4 mt-4 items-center">
          <label for="filter-type">–§—ñ–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É:</label>
          <select id="filter-type" class="border p-1 rounded">
            <option value="all">–í—Å—ñ</option>
            <option value="alcohol">–ê–ª–∫–æ</option>
            <option value="nonalcohol">–ù–µ–∞–ª–∫–æ</option>
          </select>
        </div>
      `;
    }

    container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded" autocomplete="off">
        ${tabName === 'capovane'
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok" required class="border p-2 w-full rounded" autocomplete="off">`
          : `<input type="number" step="any" id="${tabName}-quantity" placeholder="Zvy≈°ok" required class="border p-2 w-full rounded" autocomplete="off">`
        }
        ${tabName === 'purchase' ? `<input type="text" id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mt-1" autocomplete="off">` : ''}
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      ${filterHtml}
      <div class="flex gap-4 mt-4">
        <button onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">–ó–æ—Äa–¥–∏—Ç–∏ –∑–∞ –Ω–∞–∑–≤–æ—é</button>
        <button onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">–ó–æ—Äa–¥–∏—Ç–∏ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é</button>
      </div>
      <table class="w-full mt-2 table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">Meno</th>
            <th class="p-2 border">Zvy≈°ok</th>
            ${tabName === 'purchase' ? `<th class="p-2 border">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>` : ''}
            <th class="p-2 border">–ó–º—ñ–Ω–∏—Ç–∏</th>
            ${tabName === 'purchase' ? '<th class="p-2 border">–î—ñ—è</th>' : ''}
          </tr>
        </thead>
        <tbody id="${tabName}-table"></tbody>
      </table>
    `;

    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    document.getElementById(`form-${tabName}`).addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById(`${tabName}-name`).value.trim();
      const quantity = document.getElementById(`${tabName}-quantity`).value.trim();
      if(!name || !quantity) return;

      if(tabName === 'purchase'){
        const comment = document.getElementById(`${tabName}-comment`).value.trim();
        const type = await getTypeByName(name);
        await client.from('purchase').insert([{ name, quantity, comment, type }]);
      } else {
        await client.from(tabName).insert([{ name, quantity }]);
      }
      renderTable(tabName);
    });

    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —É purchase
    if(tabName === 'purchase'){
      document.getElementById('filter-type').addEventListener('change', () => renderTable('purchase'));
    }

    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ª–æ–∫–∞–ª—å–Ω–∞
    if(tabName === 'purchase'){
      const filter = document.getElementById('filter-type').value;
      if(filter !== 'all'){
        data = data.filter(item => item.type === filter);
      }
    }

    const tbody = document.getElementById(`${tabName}-table`);
    tbody.innerHTML = '';

    if(data){
      data.sort((a, b) => {
        const valA = a[currentSort.key];
        const valB = b[currentSort.key];
        return currentSort.asc
          ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true })
          : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
      });

      for(const item of data){
        // –õ–µ–≥–∫–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∏–∑—å–∫—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
        const lowQuantity = parseFloat(item.quantity) < 1;
        const quantityInput = tabName === 'capovane'
          ? `<input type="text" value="${item.quantity}" data-id="${item.id}" data-tab="${tabName}" class="quantity-input border rounded p-1 w-20">`
          : `<input type="number" step="any" value="${item.quantity}" data-id="${item.id}" data-tab="${tabName}" class="quantity-input border rounded p-1 w-20">`;

        const commentCell = tabName === 'purchase'
          ? `<td class="p-2 border"><input type="text" value="${item.comment || ''}" data-id="${item.id}" data-tab="${tabName}" class="comment-input border rounded p-1 w-full"></td>`
          : '';

        const sendBtn = (tabName === 'purchase' && lowQuantity)
          ? `<td class="p-2 border"><button data-id="${item.id}" class="send-purchase-btn bg-green-500 text-white px-2 py-1 rounded">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –Ω–∞–∫—É–ø</button></td>`
          : (tabName === 'purchase' ? '<td class="p-2 border"></td>' : '');

        tbody.insertAdjacentHTML('beforeend', `
          <tr class="${lowQuantity ? 'bg-red-100' : ''}">
            <td class="p-2 border">${item.name}</td>
            <td class="p-2 border">${quantityInput}</td>
            ${commentCell}
            <td class="p-2 border"><button data-id="${item.id}" data-tab="${tabName}" class="delete-btn bg-red-400 text-white px-2 py-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>
            ${sendBtn}
          </tr>
        `);
      }
    }

    // –ü–æ–¥—ñ—è –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
    document.querySelectorAll('.quantity-input').forEach(input => {
      input.addEventListener('change', async (e) => {
        const id = e.target.dataset.id;
        const tab = e.target.dataset.tab;
        const value = e.target.value.trim();
        await client.from(tab).update({ quantity: value }).eq('id', id);
        if(tab === 'purchase') renderTable('purchase');
      });
    });

    // –ü–æ–¥—ñ—è –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
    document.querySelectorAll('.comment-input').forEach(input => {
      input.addEventListener('change', async (e) => {
        const id = e.target.dataset.id;
        const value = e.target.value.trim();
        await client.from('purchase').update({ comment: value }).eq('id', id);
      });
    });

    // –ü–æ–¥—ñ—è –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        const tab = e.target.dataset.tab;
        await client.from(tab).delete().eq('id', id);
        renderTable(tab);
      });
    });

    // –ü–æ–¥—ñ—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –Ω–∞–∫—É–ø"
    document.querySelectorAll('.send-purchase-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        const { data } = await client.from('purchase').select('*').eq('id', id).single();
        if(data){
          // –ó–º—ñ–Ω—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ 1 —ñ –æ–Ω–æ–≤–ª—é—î–º–æ
          await client.from('purchase').update({ quantity: 1 }).eq('id', id);
          renderTable('purchase');
        }
      });
    });
  }

  function sortBy(tab, key){
    if(currentSort.key === key){
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable(tab);
  }

  // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∞–ª–∫–æ–≥–æ–ª—å
  document.querySelector('[data-tab="alcohol"]').click();
</script>
</body>
</html>
