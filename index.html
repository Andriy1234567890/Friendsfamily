<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçØ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>üç∫</span><span>ƒåapovan√©</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
  </div>

<script>
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Supabase
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  const categories = ['nonalcohol', 'alcohol', 'stock', 'monin', 'capovane', 'purchase'];

  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.remove('hidden');

      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.querySelector('h1').textContent = btn.textContent.trim();
      }

      renderTable(btn.dataset.tab);
    });
  });

  let currentSort = { key: 'name', asc: true };
  let currentFilterFromTable = 'all';

  async function renderTable(tabName) {
    // –î–ª—è purchase –≤—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä
    let query = client.from(tabName).select('*');
    if (tabName === 'purchase' && currentFilterFromTable !== 'all') {
      query = query.eq('fromTable', currentFilterFromTable);
    }
    const { data, error } = await query;
    if(error){
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);
    container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°ok (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        ${tabName === 'purchase' ? 
          `<textarea id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mb-2"></textarea>` 
          : ''
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Prida≈•</button>
      </form>
      <table class="min-w-full bg-white rounded shadow">
        <thead>
          <tr>
            <th class="p-2 cursor-pointer" data-sort="name">Meno</th>
            <th class="p-2 cursor-pointer" data-sort="quantity">Zvy≈°ok</th>
            ${tabName === 'purchase' ? '<th class="p-2">Koment√°r</th>' : ''}
            <th class="p-2">Akcie</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(row => `
            <tr data-id="${row.id}">
              <td contenteditable="true" class="p-2 name-cell">${row.name}</td>
              <td contenteditable="true" class="p-2 quantity-cell">${row.quantity}</td>
              ${tabName === 'purchase' ? `<td contenteditable="true" class="p-2 comment-cell">${row.comment || ''}</td>` : ''}
              <td class="p-2 space-x-2">
                ${tabName !== 'purchase' ? `<button class="add-to-purchase bg-green-500 text-white px-2 rounded">Nakup</button>` : ''}
                <button class="delete-btn bg-red-500 text-white px-2 rounded">Vymaza≈•</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${tabName === 'purchase' ? `<select id="filter-fromTable" class="border p-2 rounded mt-2 mb-4">
        <option value="all">V≈°etko</option>
        ${categories.filter(c => c !== 'purchase').map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>` : ''}
    `;

    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    const form = document.getElementById(`form-${tabName}`);
    form.onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById(`${tabName}-name`).value.trim();
      const quantity = document.getElementById(`${tabName}-quantity`).value.trim();
      if (tabName === 'purchase') {
        const comment = document.getElementById(`${tabName}-comment`).value.trim();
        await addRow(tabName, { name, quantity: parseFloat(quantity), comment, fromTable: 'purchase' });
      } else {
        await addRow(tabName, { name, quantity: tabName === 'capovane' ? quantity : parseFloat(quantity) });
      }
      form.reset();
      renderTable(tabName);
    };

    // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—ñ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É —Ç–∞–±–ª–∏—Ü—ñ
    container.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = async (e) => {
        const id = e.target.closest('tr').dataset.id;
        await deleteRow(tabName, id);
        renderTable(tabName);
      };
    });

    container.querySelectorAll('.add-to-purchase').forEach(btn => {
      btn.onclick = async (e) => {
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        const name = tr.querySelector('.name-cell').textContent.trim();
        const quantity = tr.querySelector('.quantity-cell').textContent.trim();
        await addToPurchase(id, name, quantity, tabName);
      };
    });

    // –û–±—Ä–æ–±–∫–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
    container.querySelectorAll('th[data-sort]').forEach(th => {
      th.onclick = () => {
        const key = th.dataset.sort;
        if (currentSort.key === key) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.key = key;
          currentSort.asc = true;
        }
        sortTable(tabName, key, currentSort.asc);
      };
    });

    // –Ø–∫—â–æ —Ü–µ –≤–∫–ª–∞–¥–∫–∞ purchase ‚Äî –¥–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–∫—É —Ñ—ñ–ª—å—Ç—Ä–∞
    if (tabName === 'purchase') {
      const filter = document.getElementById('filter-fromTable');
      filter.value = currentFilterFromTable;
      filter.onchange = () => {
        currentFilterFromTable = filter.value;
        renderTable('purchase');
      };
    }

    // –û–±—Ä–æ–±–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (on blur)
    container.querySelectorAll('tbody tr').forEach(tr => {
      tr.querySelectorAll('[contenteditable="true"]').forEach(td => {
        td.onblur = async () => {
          const id = tr.dataset.id;
          const updatedRow = {
            name: tr.querySelector('.name-cell').textContent.trim(),
            quantity: tr.querySelector('.quantity-cell').textContent.trim()
          };
          if (tabName === 'purchase') {
            updatedRow.comment = tr.querySelector('.comment-cell').textContent.trim();
          }
          // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ quantity, —è–∫—â–æ —Ü–µ –Ω–µ capovane
          if (tabName !== 'capovane') {
            updatedRow.quantity = parseFloat(updatedRow.quantity);
            if (isNaN(updatedRow.quantity)) {
              alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ');
              renderTable(tabName);
              return;
            }
          }
          await updateRow(tabName, id, updatedRow);
          renderTable(tabName);
        };
      });
    });
  }

  async function addRow(table, row) {
    const { error } = await client.from(table).insert([row]);
    if (error) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ: ' + error.message);
      console.error(error);
    }
  }

  async function deleteRow(table, id) {
    const { error } = await client.from(table).delete().eq('id', id);
    if (error) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ: ' + error.message);
      console.error(error);
    }
  }

  async function updateRow(table, id, updatedRow) {
    const { error } = await client.from(table).update(updatedRow).eq('id', id);
    if (error) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ: ' + error.message);
      console.error(error);
    }
  }

  // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ purchase
  async function addToPurchase(id, name, quantity, fromTable) {
    const quantityNum = fromTable === 'capovane' ? quantity : (typeof quantity === 'number' ? quantity : parseFloat(quantity));
    if (fromTable !== 'capovane' && isNaN(quantityNum)) {
      alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ');
      return;
    }

    const { data, error } = await client.from('purchase').insert([{ name, quantity: quantityNum, comment: '', fromTable }]);
    if (error) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –≤ Nakup: ' + error.message);
      console.error(error);
      return;
    }

    await client.from(fromTable).delete().eq('id', id);
    renderTable(fromTable);
    renderTable('purchase');
  }

  // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –º–∞—Å–∏–≤—É —ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
  async function sortTable(tabName, key, asc) {
    let { data, error } = await client.from(tabName).select('*');
    if (tabName === 'purchase' && currentFilterFromTable !== 'all') {
      data = data.filter(row => row.fromTable === currentFilterFromTable);
    }
    if (error) {
      console.error(error);
      return;
    }

    data.sort((a,b) => {
      if (a[key] < b[key]) return asc ? -1 : 1;
      if (a[key] > b[key]) return asc ? 1 : -1;
      return 0;
    });

    const container = document.getElementById(tabName);
    const tbody = container.querySelector('tbody');
    tbody.innerHTML = data.map(row => `
      <tr data-id="${row.id}">
        <td contenteditable="true" class="p-2 name-cell">${row.name}</td>
        <td contenteditable="true" class="p-2 quantity-cell">${row.quantity}</td>
        ${tabName === 'purchase' ? `<td contenteditable="true" class="p-2 comment-cell">${row.comment || ''}</td>` : ''}
        <td class="p-2 space-x-2">
          ${tabName !== 'purchase' ? `<button class="add-to-purchase bg-green-500 text-white px-2 rounded">Nakup</button>` : ''}
          <button class="delete-btn bg-red-500 text-white px-2 rounded">Vymaza≈•</button>
        </td>
      </tr>
    `).join('');

    // –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
    tbody.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = async (e) => {
        const id = e.target.closest('tr').dataset.id;
        await deleteRow(tabName, id);
        renderTable(tabName);
      };
    });

    tbody.querySelectorAll('.add-to-purchase').forEach(btn => {
      btn.onclick = async (e) => {
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        const name = tr.querySelector('.name-cell').textContent.trim();
        const quantity = tr.querySelector('.quantity-cell').textContent.trim();
        await addToPurchase(id, name, quantity, tabName);
      };
    });
  }

  // –í—ñ–¥–∫—Ä–∏—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∫–ª–∞–¥–∫—É "nonalcohol"
  renderTable('nonalcohol');
  document.querySelector('.sidebar-tab[data-tab="nonalcohol"]').classList.add('bg-gray-300');
</script>

</body>
</html>
