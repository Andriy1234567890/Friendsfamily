<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontrola zvy≈°kov</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-md">
    <nav>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
        <span>üçπ</span><span>Alko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
        <span>ü¶É</span><span>Nealko</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
        <span>üßë‚Äçüåæ</span><span>Sklad</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
        <span>üçØ</span><span>Monin</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
        <span>üç∫</span><span>ƒåapovan√©</span>
      </a>
      <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
        <span>üõí</span><span>Nakup</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="flex-1 p-6">
    <button id="menu-btn" class="md:hidden mb-4 bg-gray-200 px-4 py-2 rounded">Menu</button>
    <h1 class="text-2xl font-bold mb-4">Kontrola zvy≈°kov</h1>

    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
  </div>

<script>
  const client = window.supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  const categories = ['nonalcohol', 'alcohol', 'stock', 'monin', 'capovane', 'purchase'];

  document.getElementById('menu-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  });

  document.querySelectorAll('.sidebar-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.remove('hidden');

      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.querySelector('h1').textContent = btn.textContent.trim();
      }

      renderTable(btn.dataset.tab);
    });
  });

  let currentSort = { key: 'name', asc: true };

  async function renderTable(tabName) {
    const { data, error } = await client.from(tabName).select('*');
    if(error){
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);
    container.innerHTML = `
      <form id="form-${tabName}" class="space-y-2 mb-4">
        <input type="text" id="${tabName}-name" placeholder="Meno" required class="border p-2 w-full rounded">
        ${tabName === 'capovane' 
          ? `<input type="text" id="${tabName}-quantity" placeholder="Zvy≈°ok (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded">`
          : `<input type="number" step="0.1" min="0" id="${tabName}-quantity" placeholder="Zvy≈°ok (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" >`
        }
        ${tabName === 'purchase' ? 
          `<textarea id="${tabName}-comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" class="border p-2 w-full rounded mb-2"></textarea>` 
          : ''
        }
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Pridat</button>
      </form>
      <div class="flex gap-4 mb-2">
        <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa n√°zvu</button>
        <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">Zoradi≈• podƒæa mno≈æstva</button>
      </div>
      <table class="w-full table-auto border border-gray-300">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'name')">Meno</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('${tabName}', 'quantity')">Zvy≈°ok</th>
            <th class="p-2 border">Zmenit</th>
            ${tabName === 'purchase' ? '<th class="p-2 border">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>' : ''}
            ${tabName === 'purchase' ? '<th class="p-2 border">–î—ñ—è</th>' : ''}
            ${tabName !== 'purchase' ? '<th class="p-2 border">–î–æ–¥–∞—Ç–∏ –≤ Nakup</th>' : ''}
          </tr>
        </thead>
        <tbody id="${tabName}-table"></tbody>
      </table>
    `;

    document.getElementById(`form-${tabName}`).addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById(`${tabName}-name`).value.trim();
      const quantityInput = document.getElementById(`${tabName}-quantity`).value.trim();
      let quantity = quantityInput;

      if(tabName !== 'capovane' && tabName !== 'purchase'){
        quantity = parseFloat(quantityInput);
        if (isNaN(quantity) || quantity < 0) {
          alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ.");
          return;
        }
      }

      let comment = '';
      if(tabName === 'purchase'){
        comment = document.getElementById(`${tabName}-comment`).value.trim();
      }

      if (name && quantityInput) {
        const insertData = tabName === 'purchase' ? { name, quantity: quantityInput, comment } : { name, quantity };
        await client.from(tabName).insert([insertData]);
        renderTable(tabName);
      }
    });

    const tbody = document.getElementById(`${tabName}-table`);
    tbody.innerHTML = '';

    if (data) {
      data.sort((a, b) => {
        const valA = a[currentSort.key];
        const valB = b[currentSort.key];
        if(currentSort.key === 'quantity'){
          return currentSort.asc
            ? parseFloat(valA) - parseFloat(valB)
            : parseFloat(valB) - parseFloat(valA);
        }
        return currentSort.asc
          ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true })
          : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
      });

      for (const item of data) {
        const isLow = (tabName === 'stock' && item.quantity <= 2) ||
                      ((tabName === 'alcohol' || tabName === 'nonalcohol') && item.quantity <= 5);

        const quantityClass = isLow && tabName !== 'purchase' ? 'text-red-600 font-bold' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border p-2">${item.name}</td>
          <td class="border p-2 ${quantityClass}">
            ${tabName === 'purchase' 
              ? `<input type="text" value="${item.quantity}" data-id="${item.id}" data-table="${tabName}" class="w-full border p-1 rounded quantity-input">` 
              : `<input type="number" step="0.1" min="0" value="${item.quantity}" data-id="${item.id}" data-table="${tabName}" class="w-full border p-1 rounded quantity-input">`
            }
          </td>
          <td class="border p-2">
            <button data-id="${item.id}" data-table="${tabName}" class="update-btn bg-green-500 text-white px-2 py-1 rounded">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </td>
          ${tabName === 'purchase' ? `<td class="border p-2">
            <input type="text" value="${item.comment || ''}" data-id="${item.id}" data-table="${tabName}" class="w-full border p-1 rounded comment-input">
          </td>` : ''}
          ${tabName === 'purchase' ? `<td class="border p-2">
            <button data-id="${item.id}" data-table="${tabName}" class="delete-btn bg-red-500 text-white px-2 py-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            <button data-id="${item.id}" data-name="${item.name}" data-quantity="${item.quantity}" class="purchase-done-btn bg-blue-600 text-white px-2 py-1 rounded mt-1">–ó–∞–∫—É–ø–ª–µ–Ω–æ</button>
          </td>` : ''}
          ${tabName !== 'purchase' ? `<td class="border p-2">
            <button data-id="${item.id}" data-name="${item.name}" data-quantity="${item.quantity}" data-table="${tabName}" class="add-to-purchase-btn bg-yellow-400 text-black px-2 py-1 rounded">–í Nakup</button>
          </td>` : ''}
        `;
        tbody.appendChild(row);
      }
    }

    // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ó–±–µ—Ä–µ–≥—Ç–∏, –í–∏–¥–∞–ª–∏—Ç–∏, –í Nakup, –ó–∞–∫—É–ø–ª–µ–Ω–æ

    // –ó–±–µ—Ä–µ–≥—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (quantity) —ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è (purchase)
    tbody.querySelectorAll('.update-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const table = btn.dataset.table;

        const quantityInput = tbody.querySelector(`input.quantity-input[data-id="${id}"]`);
        let quantityValue = quantityInput.value.trim();
        if(table !== 'capovane' && table !== 'purchase'){
          quantityValue = parseFloat(quantityValue);
          if (isNaN(quantityValue) || quantityValue < 0) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ.");
            return;
          }
        }
        const updateData = { quantity: quantityValue };

        if(table === 'purchase'){
          const commentInput = tbody.querySelector(`input.comment-input[data-id="${id}"]`);
          updateData.comment = commentInput.value.trim();
        }

        const { error } = await client.from(table).update(updateData).eq('id', id);
        if(error){
          alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ' + error.message);
        } else {
          alert('–û–Ω–æ–≤–ª–µ–Ω–æ');
          renderTable(table);
        }
      });
    });

    // –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä (–ª–∏—à–µ –¥–ª—è purchase)
    tbody.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if(!confirm('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä?')) return;
        const id = btn.dataset.id;
        const table = btn.dataset.table;
        const { error } = await client.from(table).delete().eq('id', id);
        if(error){
          alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + error.message);
        } else {
          alert('–í–∏–¥–∞–ª–µ–Ω–æ');
          renderTable(table);
        }
      });
    });

    // –î–æ–¥–∞—Ç–∏ –≤ Nakup (purchase) –¥–ª—è —ñ–Ω—à–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
    tbody.querySelectorAll('.add-to-purchase-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if(!confirm(`–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä "${btn.dataset.name}" —É Nakup?`)) return;

        const id = btn.dataset.id;
        const table = btn.dataset.table;
        const name = btn.dataset.name;
        const quantity = btn.dataset.quantity;

        // –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–º–æ –≤ purchase –∑ –ø–æ–ª–µ–º source=–ø–æ—á–∞—Ç–∫–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è
        const { error: insertErr } = await client.from('purchase').insert([{
          name,
          quantity,
          source: table,  // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ
          comment: ''
        }]);

        if(insertErr){
          alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —É Nakup: ' + insertErr.message);
          return;
        }

        // –í–∏–¥–∞–ª–∏–º–æ –∑ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        const { error: delErr } = await client.from(table).delete().eq('id', id);
        if(delErr){
          alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ' + delErr.message);
          return;
        }

        alert(`–¢–æ–≤–∞—Ä "${name}" –¥–æ–¥–∞–Ω–æ —É Nakup.`);
        renderTable('purchase');
        renderTable(table);
      });
    });

    // –ö–Ω–æ–ø–∫–∞ –ó–∞–∫—É–ø–ª–µ–Ω–æ —É purchase
    if(tabName === 'purchase'){
      tbody.querySelectorAll('.purchase-done-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if(!confirm(`–í–∏ –¥—ñ–π—Å–Ω–æ –∑–∞–∫—É–ø–∏–ª–∏ —Ç–æ–≤–∞—Ä "${btn.dataset.name}" —É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ ${btn.dataset.quantity}?`)) return;

          const id = btn.dataset.id;
          const name = btn.dataset.name;
          const purchasedQuantityRaw = btn.dataset.quantity;

          // –ü—Ä–æ–±—É—î–º–æ –∫–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É —á–∏—Å–ª–æ, —è–∫—â–æ –º–æ–∂–ª–∏–≤–æ
          let purchasedQuantity = parseFloat(purchasedQuantityRaw);
          if(isNaN(purchasedQuantity)){
            // –Ø–∫—â–æ –Ω–µ —á–∏—Å–ª–æ, –∑–∞–ª–∏—à–∞—î–º–æ —Ä—è–¥–∫–æ–º (–¥–ª—è capovane)
            purchasedQuantity = purchasedQuantityRaw;
          }

          // –û—Ç—Ä–∏–º—É—î–º–æ –∑–∞–ø–∏—Å purchase, —â–æ–± –∑–Ω–∞—Ç–∏ source
          const { data: purchaseItem, error: purchaseErr } = await client.from('purchase').select('*').eq('id', id).single();

          if(purchaseErr){
            alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + purchaseErr.message);
            return;
          }

          const originCategory = purchaseItem.source || 'stock'; // –Ø–∫—â–æ –ø–æ–ª–µ source –Ω–µ–º–∞—î, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ stock

          // –û—Ç—Ä–∏–º–∞—î–º–æ —Ç–æ–≤–∞—Ä –∑ originCategory –∑ —Ç–∞–∫–∏–º —Å–∞–º–∏–º —ñ–º'—è–º
          const { data: originItems, error: originErr } = await client.from(originCategory).select('*').eq('name', name);

          if(originErr){
            alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ' + originErr.message);
            return;
          }

          if(originItems.length > 0){
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
            const originItem = originItems[0];

            let newQuantity;
            if(typeof purchasedQuantity === 'number' && !isNaN(originItem.quantity)){
              newQuantity = parseFloat(originItem.quantity) + purchasedQuantity;
            } else {
              // –Ø–∫—â–æ –Ω–µ —á–∏—Å–ª–æ–≤—ñ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, capovane - —Ç–µ–∫—Å—Ç)
              newQuantity = purchasedQuantityRaw; 
            }

            const { error: updateErr } = await client.from(originCategory).update({ quantity: newQuantity }).eq('id', originItem.id);
            if(updateErr){
              alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ: ' + updateErr.message);
              return;
            }
          } else {
            // –í—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å
            const insertData = {
              name,
              quantity: purchasedQuantityRaw
            };

            const { error: insertErr } = await client.from(originCategory).insert([insertData]);
            if(insertErr){
              alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É: ' + insertErr.message);
              return;
            }
          }

          // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–ø–∏—Å –∑ purchase
          const { error: delErr } = await client.from('purchase').delete().eq('id', id);
          if(delErr){
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ Nakup: ' + delErr.message);
            return;
          }

          alert(`–¢–æ–≤–∞—Ä "${name}" –∑–∞–∫—É–ø–ª–µ–Ω–æ —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é "${originCategory}".`);

          renderTable('purchase');
          renderTable(originCategory);
        });
      });
    }
  }

  // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  function sortBy(tabName, key){
    if(currentSort.key === key){
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    renderTable(tabName);
  }

  // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä—à—É –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.sidebar-tab').click();
  });

</script>

</body>
</html>
