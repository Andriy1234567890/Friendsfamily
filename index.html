<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бар Інвентар та Накуп</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
      color: #333;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #34495e;
      gap: 1rem;
      padding: 0.5rem 0;
    }
    nav button {
      background: transparent;
      border: none;
      color: #ecf0f1;
      font-weight: 600;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    nav button.active,
    nav button:hover {
      background: #1abc9c;
      color: white;
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #16a085;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #ecf0f1;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    th:hover {
      background: #bdc3c7;
    }
    th::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      border: 5px solid transparent;
      border-top-color: transparent;
      border-bottom-color: transparent;
      transform: translateY(-50%);
      opacity: 0.3;
    }
    th.sorted-asc::after {
      border-bottom-color: #16a085;
      border-top-color: transparent;
      opacity: 1;
    }
    th.sorted-desc::after {
      border-top-color: #16a085;
      border-bottom-color: transparent;
      opacity: 1;
    }
    input[type="number"] {
      width: 60px;
      padding: 0.25rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      text-align: right;
    }
    button.action-btn {
      background: #16a085;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button.action-btn:hover {
      background: #13876a;
    }
    .filter-buttons {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .filter-buttons button {
      background: #bdc3c7;
      color: #34495e;
      font-weight: 600;
      padding: 0.3rem 0.7rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .filter-buttons button.active,
    .filter-buttons button:hover {
      background: #16a085;
      color: white;
    }
  </style>
</head>
<body>

<header>Бар Інвентар та Накуп</header>

<nav id="tabs">
  <button class="tab-btn active" data-tab="alko">Алко</button>
  <button class="tab-btn" data-tab="nealko">Неалко</button>
  <button class="tab-btn" data-tab="sklad">Склад</button>
  <button class="tab-btn" data-tab="monin">Monin</button>
  <button class="tab-btn" data-tab="capovane">Capovane</button>
  <button class="tab-btn" data-tab="purchase">Накуп</button>
</nav>

<main>
  <section id="alko" class="tab-content"></section>
  <section id="nealko" class="tab-content" style="display:none;"></section>
  <section id="sklad" class="tab-content" style="display:none;"></section>
  <section id="monin" class="tab-content" style="display:none;"></section>
  <section id="capovane" class="tab-content" style="display:none;"></section>
  <section id="purchase" class="tab-content" style="display:none;"></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const client = supabase.createClient(
    "https://wmjvkmdignmlnbphqxxd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
  );

  let currentSort = { key: 'name', asc: true };
  let currentPurchaseSort = { key: 'name', asc: true };
  let currentPurchaseFilter = 'all';

  // Таблиці для вкладок
  const tabs = ['alko', 'nealko', 'sklad', 'monin', 'capovane', 'purchase'];

  // Функція для рендеру вкладок крім purchase
  async function renderTable(tabName) {
    const { data, error } = await client.from(tabName).select('*');
    if (error) {
      console.error(error);
      return;
    }

    const container = document.getElementById(tabName);
    if (!container) return;

    // Сортування
    const sortedData = [...data].sort((a, b) => {
      const valA = a[currentSort.key];
      const valB = b[currentSort.key];
      if (currentSort.key === 'quantity') {
        return currentSort.asc ? parseFloat(valA) - parseFloat(valB) : parseFloat(valB) - parseFloat(valA);
      }
      return currentSort.asc ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true }) : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
    });

    container.innerHTML = `
      <h2>${tabName.toUpperCase()}</h2>
      <table>
        <thead>
          <tr>
            <th class="${currentSort.key === 'name' ? (currentSort.asc ? 'sorted-asc' : 'sorted-desc') : ''}" onclick="sortBy('${tabName}', 'name')">Назва</th>
            <th class="${currentSort.key === 'quantity' ? (currentSort.asc ? 'sorted-asc' : 'sorted-desc') : ''}" onclick="sortBy('${tabName}', 'quantity')">Кількість</th>
            <th>Дія</th>
          </tr>
        </thead>
        <tbody>
          ${sortedData.map(item => `
            <tr>
              <td>${item.name}</td>
              <td><input type="number" min="0" step="0.1" value="${item.quantity}" onchange="updateQuantity('${tabName}', ${item.id}, this.value)"></td>
              <td><button class="action-btn" onclick="addToPurchase('${tabName}', ${item.id})">Odoslat do nakupu</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // Оновлення кількості продукту
  async function updateQuantity(tabName, id, newQuantity) {
    const qty = parseFloat(newQuantity);
    if (isNaN(qty) || qty < 0) return;
    const { error } = await client.from(tabName).update({ quantity: qty }).eq('id', id);
    if (error) console.error(error);
    else {
      if (tabName === 'purchase') renderPurchaseTable(currentPurchaseFilter);
      else renderTable(tabName);
    }
  }

  // Додавання в накуп
  async function addToPurchase(tabName, id) {
    const { data, error } = await client.from(tabName).select('*').eq('id', id).single();
    if (error || !data) {
      console.error(error || 'Продукт не знайдено');
      return;
    }

    // Перевірка чи товар вже в purchase
    const { data: existing, error: errExisting } = await client.from('purchase').select('*').eq('name', data.name).single();

    if (errExisting) {
      console.error(errExisting);
      return;
    }

    if (existing) {
      // Оновити кількість
      const updatedQuantity = parseFloat(existing.quantity) + parseFloat(data.quantity);
      const { error: errUpdate } = await client.from('purchase').update({ quantity: updatedQuantity }).eq('id', existing.id);
      if (errUpdate) console.error(errUpdate);
    } else {
      // Додати новий
      const insertObj = { name: data.name, quantity: data.quantity };
      // Додатково можна додати категорію, якщо є
      if (data.category) insertObj.category = data.category;
      const { error: errInsert } = await client.from('purchase').insert([insertObj]);
      if (errInsert) console.error(errInsert);
    }

    renderPurchaseTable(currentPurchaseFilter);
  }

  // Рендер purchase з фільтрами
  async function renderPurchaseTable(filterCategory) {
    currentPurchaseFilter = filterCategory || 'all';

    let query = client.from('purchase').select('*');
    if (filterCategory && filterCategory !== 'all') {
      query = query.eq('category', filterCategory);
    }

    const { data, error } = await query;
    if (error) {
      console.error(error);
      return;
    }

    const container = document.getElementById('purchase');
    if (!container) return;

    // Сортуємо
    const sortedData = [...(data || [])].sort((a, b) => {
      const valA = a[currentPurchaseSort.key];
      const valB = b[currentPurchaseSort.key];
      if (currentPurchaseSort.key === 'quantity') {
        return currentPurchaseSort.asc ? parseFloat(valA) - parseFloat(valB) : parseFloat(valB) - parseFloat(valA);
      }
      return currentPurchaseSort.asc ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true }) : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
    });

    container.innerHTML = `
      <h2>НАкуп</h2>
      <div class="filter-buttons">
        ${['all','alko','nealko','sklad','monin','capovane'].map(cat => `
          <button class="${currentPurchaseFilter === cat ? 'active' : ''}" onclick="renderPurchaseTable('${cat}')">
            ${cat === 'all' ? 'Всі' : cat.charAt(0).toUpperCase() + cat.slice(1)}
          </button>
        `).join('')}
      </div>
      <table>
        <thead>
          <tr>
            <th class="${currentPurchaseSort.key === 'name' ? (currentPurchaseSort.asc ? 'sorted-asc' : 'sorted-desc') : ''}" onclick="sortBy('purchase', 'name')">Назва</th>
            <th class="${currentPurchaseSort.key === 'quantity' ? (currentPurchaseSort.asc ? 'sorted-asc' : 'sorted-desc') : ''}" onclick="sortBy('purchase', 'quantity')">Кількість</th>
            <th>Дія</th>
          </tr>
        </thead>
        <tbody>
          ${sortedData.map(item => `
            <tr>
              <td>${item.name}</td>
              <td><input type="number" min="0" step="0.1" value="${item.quantity}" onchange="updateQuantity('purchase', ${item.id}, this.value)"></td>
              <td><button class="action-btn" onclick="removeFromPurchase(${item.id})">Видалити</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // Видалити з purchase
  async function removeFromPurchase(id) {
    const { error } = await client.from('purchase').delete().eq('id', id);
    if (error) {
      console.error(error);
    } else {
      renderPurchaseTable(currentPurchaseFilter);
    }
  }

  // Сортування
  function sortBy(tabName, key) {
    if (tabName === 'purchase') {
      if (currentPurchaseSort.key === key) {
        currentPurchaseSort.asc = !currentPurchaseSort.asc;
      } else {
        currentPurchaseSort.key = key;
        currentPurchaseSort.asc = true;
      }
      renderPurchaseTable(currentPurchaseFilter);
    } else {
      if (currentSort.key === key) {
        currentSort.asc = !currentSort.asc;
      } else {
        currentSort.key = key;
        currentSort.asc = true;
      }
      renderTable(tabName);
    }
  }

  // Обробка кліку по табах
  document.getElementById('tabs').addEventListener('click', e => {
    if (!e.target.classList.contains('tab-btn')) return;
    // Активна кнопка
    [...document.querySelectorAll('.tab-btn')].forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    const tab = e.target.dataset.tab;
    // Показати відповідну вкладку, сховати інші
    tabs.forEach(t => {
      document.getElementById(t).style.display = (t === tab) ? 'block' : 'none';
    });
    // Рендер контенту вкладки (щоб оновити, на випадок)
    if (tab === 'purchase') {
      renderPurchaseTable(currentPurchaseFilter);
    } else {
      renderTable(tab);
    }
  });

  // Початковий рендер
  renderTable('alko');
</script>

</body>
</html>
