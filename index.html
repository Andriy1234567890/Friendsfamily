<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ë–∞—Ä —ñ–Ω–≤–µ–Ω—Ç–∞—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- –°–∞–π–¥–±–∞—Ä -->
  <nav class="w-48 bg-white shadow-md p-4 flex flex-col space-y-1">
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="nonalcohol">
      <span>ü¶É</span><span>Nealko</span>
    </a>
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="alcohol">
      <span>üçπ</span><span>Alko</span>
    </a>
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="stock">
      <span>üßë‚Äçüåæ</span><span>Sklad</span>
    </a>
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="monin">
      <span>üçØ</span><span>Monin</span>
    </a>
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="capovane">
      <span>üç∫</span><span>ƒåapovan√©</span>
    </a>
    <a href="#" class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-200 rounded sidebar-tab" data-tab="purchase">
      <span>üõí</span><span>Nakup</span>
    </a>
  </nav>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="flex-1 p-6">
    <div id="nonalcohol" class="tab-content hidden"></div>
    <div id="alcohol" class="tab-content hidden"></div>
    <div id="stock" class="tab-content hidden"></div>
    <div id="monin" class="tab-content hidden"></div>
    <div id="capovane" class="tab-content hidden"></div>
    <div id="purchase" class="tab-content hidden"></div>
  </main>

  <script>
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Supabase
    const client = window.supabase.createClient(
  "https://wmjvkmdignmlnbphqxxd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtanZrbWRpZ25tbG5icGhxeHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0MzMsImV4cCI6MjA2NDA5MTQzM30.EnEcHJaVyOj6IPmBTR_L2U5BazeaWK3kLnE9aycVZC8"
);
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // –ê–∫—Ç–∏–≤–Ω–∞ –≤–∫–ª–∞–¥–∫–∞
    let activeTab = 'nonalcohol';

    // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –ø–æ —Ç–∞–±–∞—Ö (—Å–∞–π–¥–±–∞—Ä)
    document.querySelectorAll('.sidebar-tab').forEach(el => {
      el.addEventListener('click', e => {
        e.preventDefault();
        const tabName = el.dataset.tab;
        if (tabName === activeTab) return;

        document.getElementById(activeTab).classList.add('hidden');
        activeTab = tabName;
        document.getElementById(activeTab).classList.remove('hidden');

        renderTable(activeTab);
      });
    });

    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–µ—Ä—à—É –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    document.querySelector('.sidebar-tab[data-tab="nonalcohol"]').click();

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
    async function renderTable(tabName) {
      const container = document.getElementById(tabName);

      if (tabName === 'purchase') {
        container.innerHTML = `
          <label for="filter-category" class="block mb-2 font-semibold">–§—ñ–ª—å—Ç—Ä –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é:</label>
          <select id="filter-category" class="border p-2 rounded mb-4 w-full max-w-xs">
            <option value="all">–í—Å—ñ</option>
            <option value="alcohol">Alko</option>
            <option value="nonalcohol">Nealko</option>
            <option value="stock">Sklad</option>
            <option value="monin">Monin</option>
            <option value="capovane">ƒåapovan√©</option>
          </select>
          <div id="purchase-table-container"></div>
        `;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –æ–¥–Ω–æ—á–∞—Å–Ω–æ
        const [purchaseRes, alcoholRes, nonalcoholRes, stockRes, moninRes, capovaneRes] = await Promise.all([
          client.from('purchase').select('*'),
          client.from('alcohol').select('name'),
          client.from('nonalcohol').select('name'),
          client.from('stock').select('name'),
          client.from('monin').select('name'),
          client.from('capovane').select('name'),
        ]);

        if (purchaseRes.error) {
          container.innerHTML = `<p class="text-red-600">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è purchase: ${purchaseRes.error.message}</p>`;
          return;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ –Ω–∞–∑–≤—ñ —Ç–æ–≤–∞—Ä—É
        function findCategoryByName(name) {
          if (alcoholRes.data.some(x => x.name === name)) return 'alcohol';
          if (nonalcoholRes.data.some(x => x.name === name)) return 'nonalcohol';
          if (stockRes.data.some(x => x.name === name)) return 'stock';
          if (moninRes.data.some(x => x.name === name)) return 'monin';
          if (capovaneRes.data.some(x => x.name === name)) return 'capovane';
          return 'unknown';
        }

        // –î–æ–¥–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–æ purchase
        let allPurchases = purchaseRes.data.map(item => ({
          ...item,
          category: findCategoryByName(item.name)
        }));

        // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–º–∞–ª—é–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é purchase
        function renderPurchaseTable(data) {
          const container = document.getElementById('purchase-table-container');
          if (data.length === 0) {
            container.innerHTML = '<p>–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.</p>';
            return;
          }
          let html = `
            <table class="w-full table-auto border border-gray-300">
              <thead>
                <tr class="bg-gray-200">
                  <th class="p-2 border">–ù–∞–∑–≤–∞</th>
                  <th class="p-2 border">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                  <th class="p-2 border">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                  <th class="p-2 border">–î—ñ—è</th>
                </tr>
              </thead>
              <tbody>
          `;
          for (const item of data) {
            html += `
              <tr class="border-b">
                <td class="p-2 border">${item.name}</td>
                <td class="p-2 border">${item.quantity}</td>
                <td class="p-2 border">${item.comment || ''}</td>
                <td class="p-2 border">
                  <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="markAsPurchased('${item.name}')">–ó–∞–∫—É–ø–ª–µ–Ω–æ</button>
                </td>
              </tr>
            `;
          }
          html += '</tbody></table>';
          container.innerHTML = html;
        }

        // –°–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ —Ç–æ–≤–∞—Ä–∏
        renderPurchaseTable(allPurchases);

        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Ñ—ñ–ª—å—Ç—Ä—É
        document.getElementById('filter-category').addEventListener('change', e => {
          const val = e.target.value;
          if (val === 'all') {
            renderPurchaseTable(allPurchases);
          } else {
            renderPurchaseTable(allPurchases.filter(x => x.category === val));
          }
        });

        return;
      }

      // –î–ª—è —ñ–Ω—à–∏—Ö –≤–∫–ª–∞–¥–æ–∫ ‚Äì –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ + —Ñ–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
      container.innerHTML = `
        <form id="form-${tabName}" class="space-y-2 mb-4">
          <input type="text" id="${tabName}-name" placeholder="–ù–∞–∑–≤–∞" required class="border p-2 w-full rounded" />
          ${tabName === 'capovane' 
            ? `<input type="text" id="${tabName}-quantity" placeholder="–ó–∞–ª–∏—à–æ–∫ (–±—É–∫–≤–∏ –∞–±–æ —Ü–∏—Ñ—Ä–∏)" required class="border p-2 w-full rounded" />`
            : `<input type="number" step="1" min="0" id="${tabName}-quantity" placeholder="–ó–∞–ª–∏—à–æ–∫ (—á–∏—Å–ª–æ)" required class="border p-2 w-full rounded" />`
          }
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">–î–æ–¥–∞—Ç–∏</button>
        </form>
        <div class="flex gap-4 mb-2">
          <button type="button" onclick="sortBy('${tabName}', 'name')" class="bg-gray-300 px-3 py-1 rounded">–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –Ω–∞–∑–≤–æ—é</button>
          <button type="button" onclick="sortBy('${tabName}', 'quantity')" class="bg-gray-300 px-3 py-1 rounded">–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é</button>
        </div>
        <table class="w-full table-auto border border-gray-300">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2 border">–ù–∞–∑–≤–∞</th>
              <th class="p-2 border">–ó–∞–ª–∏—à–æ–∫</th>
              <th class="p-2 border">–î—ñ—è</th>
            </tr>
          </thead>
          <tbody id="${tabName}-table"></tbody>
        </table>
      `;

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ —É —Ç–∞–±–ª–∏—Ü—ñ
      const { data, error } = await client.from(tabName).select('*');
      if (error) {
        container.innerHTML += `<p class="text-red-600">–ü–æ–º–∏–ª–∫–∞: ${error.message}</p>`;
        return;
      }

      const tbody = document.getElementById(`${tabName}-table`);
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2 border">${item.name}</td>
          <td class="p-2 border">${item.quantity}</td>
          <td class="p-2 border">
            <button onclick="deleteItem('${tabName}', '${item.id}')" class="bg-red-600 text-white px-2 py-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // –û–±—Ä–æ–±–Ω–∏–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É
      const form = document.getElementById(`form-${tabName}`);
      form.onsubmit = async (e) => {
        e.preventDefault();
        const name = document.getElementById(`${tabName}-name`).value.trim();
        const quantityInput = document.getElementById(`${tabName}-quantity`);
        const quantity = tabName === 'capovane' ? quantityInput.value.trim() : parseFloat(quantityInput.value);
        if (!name || (!quantity && quantity !== 0)) return alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥–∞–Ω—ñ');

        const { error } = await client.from(tabName).insert([{ name, quantity }]);
        if (error) {
          alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è: ' + error.message);
          return;
        }
        form.reset();
        renderTable(tabName);
      };
    }

    // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –¥—ñ–π
    async function deleteItem(table, id) {
      if (!confirm('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) return;
      const { error } = await client.from(table).delete().eq('id', id);
      if (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + error.message);
        return;
      }
      renderTable(activeTab);
    }

    window.deleteItem = deleteItem;

    // –§—É–Ω–∫—Ü—ñ—è –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è —è–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ (–º–æ–∂–µ—à –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —Å–≤–æ—é –ª–æ–≥—ñ–∫—É)
    async function markAsPurchased(name) {
      alert(`–ü–æ–∑–Ω–∞—á–∏—Ç–∏ "${name}" —è–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ ‚Äî –¥–æ–¥–∞–π —Å–≤–æ—é –ª–æ–≥—ñ–∫—É —Ç—É—Ç`);
      // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ purchase –∞–±–æ —ñ–Ω—à—ñ –¥—ñ—ó
    }

    window.markAsPurchased = markAsPurchased;

    // –§—É–Ω–∫—Ü—ñ—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å
    window.sortBy = async function(tabName, field) {
      const { data, error } = await client.from(tabName).select('*').order(field, { ascending: true });
      if (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: ' + error.message);
        return;
      }
      const tbody = document.getElementById(`${tabName}-table`);
      if (!tbody) return;
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2 border">${item.name}</td>
          <td class="p-2 border">${item.quantity}</td>
          <td class="p-2 border">
            <button onclick="deleteItem('${tabName}', '${item.id}')" class="bg-red-600 text-white px-2 py-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };
  </script>
</body>
</html>
